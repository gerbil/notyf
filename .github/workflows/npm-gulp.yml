name: Build Notyf & Upload to Release

on:
  push:
    tags:
      - "v*"             # build when you push a tag like v3.0.0
  workflow_dispatch:      # allow manual runs too

permissions:
  contents: write         # needed to create/update Releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (old LTS for node-sass@4)
        uses: actions/setup-node@v4
        with:
          node-version: 14
          cache: npm

      # Keep npm that ships with Node 14 (npm v6) to match old lockfiles.
      # If your runner upgrades npm, uncomment the next line:
      # - run: npm i -g npm@6

      - name: Clean install
        run: npm ci
        env:
          npm_config_build_from_source: false  # prefer prebuilt node-sass binaries

      - name: Build
        run: npm run build

      - name: Verify build output exists
        run: |
          test -d dist || { echo "dist/ not found after build"; exit 1; }
          ls -la dist

      # Keep a copy in the workflow run as well (handy for debugging)
      - name: Upload build as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: notyf-dist-${{ github.ref_name || github.run_number }}
          path: dist

      - name: Package archives
        run: |
          tar -czf notyf-dist-${{ github.ref_name || 'manual' }}.tar.gz dist
          zip -r  notyf-dist-${{ github.ref_name || 'manual' }}.zip dist

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        tag_name: master
        with:
          files: |
            notyf-dist-master.tar.gz
            notyf-dist-master.zip
            dist/**/*.js
            dist/**/*.css
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
